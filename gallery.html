<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama Memories - Wilmington 2026</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial Black', sans-serif;
            background: #000;
            color: #fff;
            padding-top: 100px;
        }
        nav {
            position: fixed; top: 0; width: 100%;
            background: rgba(0, 0, 0, 0.9);
            padding: 1rem; z-index: 1000;
            border-bottom: 2px solid #ff00ff;
            text-align: center;
        }
        nav a { color: #00ffff; text-decoration: none; margin: 0 15px; font-weight: 900; text-transform: uppercase; }
        
        .upload-card {
            max-width: 500px; margin: 0 auto 3rem auto; padding: 2rem;
            border: 2px solid #ff00ff; border-radius: 15px; text-align: center;
            background: #111; box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
        }
        .upload-btn {
            padding: 12px 24px; background: #00ffff; color: #000;
            border: none; border-radius: 25px; font-weight: 900;
            cursor: pointer; margin-top: 15px; text-transform: uppercase;
        }
        .upload-btn:disabled { background: #333; color: #666; cursor: not-allowed; }

        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto;
        }
        .gallery-item { height: 300px; border-radius: 10px; overflow: hidden; background: #222; border: 1px solid #333; }
        .gallery-item img, .gallery-item video { width: 100%; height: 100%; object-fit: cover; }
        .status-msg { margin-top: 10px; color: #ffff00; font-size: 0.9rem; font-family: sans-serif; }
    </style>
</head>
<body>

    <nav>
        <a href="index.html">Home</a>
        <a href="gallery.html">Gallery</a>
    </nav>

    <header style="text-align: center; margin-bottom: 2rem;">
        <h1 style="color: #ff00ff; text-transform: uppercase;">Llama Memories</h1>
    </header>

    <section class="upload-card">
        <h2 style="color:#ff00ff; margin-bottom:15px; font-size: 1.2rem;">SUBMIT MEDIA</h2>
        <input type="file" id="file-selector" accept="image/*,video/*">
        <br>
        <button id="upload-btn" class="upload-btn">BEAM UP ðŸ›¸</button>
        <div id="upload-status" class="status-msg">Waiting for file...</div>
    </section>

    <div class="gallery-grid" id="gallery-grid"></div>

    <script>
        // --- CONFIGURATION ---
        const IK_PUBLIC_KEY = "public_1ErPhSlplr1rBPQCe5DZtkYi+CY=";
        const CLOUDFLARE_AUTH_ENDPOINT = "https://nc2026photoupload.littleredatom.workers.dev/";
        const RESTRICTED_API_KEY = "private_/k8K1Gh7XeNUfj7kL0X0qgo7lCg=";
        // Direct API endpoint for uploads (Bypassing SDK)
        const UPLOAD_API_URL = "https://upload.imagekit.io/api/v1/files/upload";

        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-selector');
        const status = document.getElementById('upload-status');
        const grid = document.getElementById('gallery-grid');

        // 1. Gallery Loader
        async function loadGallery() {
            const b64Key = btoa(RESTRICTED_API_KEY + ":");
            try {
                const response = await fetch("https://api.imagekit.io/v1/files?tags=meetup2026", {
                    headers: { 'Authorization': `Basic ${b64Key}` }
                });
                const files = await response.json();
                grid.innerHTML = '';
                files.forEach(file => {
                    const isVid = file.fileType === 'non-image' && file.mime.includes('video');
                    addPhotoToGrid(file.url, isVid);
                });
            } catch (err) {
                console.error("Gallery Load Fail:", err);
                status.innerText = "Gallery failed to load.";
            }
        }

        function addPhotoToGrid(url, isVideo = false) {
            const div = document.createElement('div');
            div.className = 'gallery-item';
            const thumbUrl = isVideo ? url : `${url}?tr=w-600`;
            div.innerHTML = isVideo ? `<video src="${url}" controls></video>` : `<img src="${thumbUrl}" loading="lazy">`;
            grid.prepend(div);
        }

        // 2. THE MANUAL UPLOAD FUNCTION (No SDK!)
        uploadBtn.addEventListener('click', async function() {
            const file = fileInput.files[0];
            if (!file) return alert("Select a file!");

            uploadBtn.disabled = true;
            status.innerText = "Getting permission... ðŸ”‘";

            try {
                // Step A: Get Signature from Cloudflare
                const authResponse = await fetch(CLOUDFLARE_AUTH_ENDPOINT);
                if (!authResponse.ok) throw new Error("Worker Auth Failed");
                const authData = await authResponse.json();

                status.innerText = "Beaming up... ðŸ›¸";

                // Step B: Build the Form Data manually
                const formData = new FormData();
                formData.append("file", file);
                formData.append("fileName", file.name);
                formData.append("publicKey", IK_PUBLIC_KEY);
                formData.append("signature", authData.signature);
                formData.append("expire", authData.expire);
                formData.append("token", authData.token);
                formData.append("tags", "meetup2026");

                // Step C: Send directly to ImageKit API
                const uploadResponse = await fetch(UPLOAD_API_URL, {
                    method: "POST",
                    body: formData
                });

                const result = await uploadResponse.json();

                if (!uploadResponse.ok) {
                    throw new Error(result.message || "Upload Server Error");
                }

                status.innerText = "Touchdown! Success.";
                addPhotoToGrid(result.url, file.type.includes('video'));

            } catch (err) {
                console.error("Upload Error:", err);
                status.innerText = "Error: " + err.message;
            } finally {
                uploadBtn.disabled = false;
            }
        });

        // Initialize
        loadGallery();
    </script>
</body>
</html>

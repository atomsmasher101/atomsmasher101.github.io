<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama Memories - Wilmington 2026</title>
    
    <script src="https://cdn.jsdelivr.net/npm/imagekit-javascript@1.5.9/dist/imagekit.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial Black', sans-serif;
            background: #000;
            color: #fff;
            padding-top: 100px;
        }
        nav {
            position: fixed; top: 0; width: 100%;
            background: rgba(0, 0, 0, 0.9);
            padding: 1rem; z-index: 1000;
            border-bottom: 2px solid #ff00ff;
            text-align: center;
        }
        nav a { color: #00ffff; text-decoration: none; margin: 0 15px; font-weight: 900; text-transform: uppercase; }
        
        .upload-card {
            max-width: 500px; margin: 0 auto 3rem auto; padding: 2rem;
            border: 2px solid #ff00ff; border-radius: 15px; text-align: center;
            background: #111; box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
        }
        .upload-btn {
            padding: 12px 24px; background: #00ffff; color: #000;
            border: none; border-radius: 25px; font-weight: 900;
            cursor: pointer; margin-top: 15px; text-transform: uppercase;
        }
        .upload-btn:disabled { background: #333; color: #666; cursor: not-allowed; }

        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto;
        }
        .gallery-item { height: 300px; border-radius: 10px; overflow: hidden; background: #222; border: 1px solid #333; }
        .gallery-item img, .gallery-item video { width: 100%; height: 100%; object-fit: cover; }
        .status-msg { margin-top: 10px; color: #ffff00; font-size: 0.9rem; font-family: sans-serif; }
    </style>
</head>
<body>

    <nav>
        <a href="index.html">Home</a>
        <a href="gallery.html">Gallery</a>
    </nav>

    <header style="text-align: center; margin-bottom: 2rem;">
        <h1 style="color: #ff00ff; text-transform: uppercase;">Llama Memories</h1>
    </header>

    <section class="upload-card">
        <h2 style="color:#ff00ff; margin-bottom:15px; font-size: 1.2rem;">SUBMIT MEDIA</h2>
        <input type="file" id="file-selector" accept="image/*,video/*">
        <br>
        <button id="upload-btn" class="upload-btn">BEAM UP ðŸ›¸</button>
        <div id="upload-status" class="status-msg">Waiting for file...</div>
    </section>

    <div class="gallery-grid" id="gallery-grid"></div>

    <script>
        // 2. Safety Wrap: Wait for window and SDK to be ready
        window.addEventListener('load', function() {
            
            if (typeof ImageKit === 'undefined') {
                console.error("ImageKit SDK not found!");
                document.getElementById('upload-status').innerText = "Error: SDK failed to load.";
                return;
            }

            // --- SETTINGS ---
            const IK_PUBLIC_KEY = "public_1ErPhSlplr1rBPQCe5DZtkYi+CY=";
            const IK_URL_ENDPOINT = "https://ik.imagekit.io/atomsmasher101/";
            const CLOUDFLARE_AUTH_ENDPOINT = "https://nc2026photoupload.littleredatom.workers.dev/";
            const RESTRICTED_API_KEY = "private_/k8K1Gh7XeNUfj7kL0X0qgo7lCg=";

            const imagekit = new ImageKit({
                publicKey: IK_PUBLIC_KEY,
                urlEndpoint: IK_URL_ENDPOINT
            });

            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-selector');
            const status = document.getElementById('upload-status');
            const grid = document.getElementById('gallery-grid');

            // --- FUNCTIONS ---

            async function loadGallery() {
                const b64Key = btoa(RESTRICTED_API_KEY + ":");
                try {
                    const response = await fetch("https://api.imagekit.io/v1/files?tags=meetup2026", {
                        headers: { 'Authorization': `Basic ${b64Key}` }
                    });
                    if (!response.ok) throw new Error("API Fetch Failed");
                    const files = await response.json();
                    grid.innerHTML = '';
                    files.forEach(file => {
                        const isVid = file.fileType === 'non-image' && file.mime.includes('video');
                        addPhotoToGrid(file.url, isVid);
                    });
                } catch (err) {
                    console.error("Gallery Load Fail:", err);
                    status.innerText = "Could not load gallery.";
                }
            }

            function addPhotoToGrid(url, isVideo = false) {
                const div = document.createElement('div');
                div.className = 'gallery-item';
                const thumbUrl = isVideo ? url : `${url}?tr=w-600`;
                div.innerHTML = isVideo ? `<video src="${url}" controls></video>` : `<img src="${thumbUrl}" loading="lazy">`;
                grid.prepend(div);
            }

            // --- UPLOAD HANDLER ---

            uploadBtn.addEventListener('click', function() {
                const file = fileInput.files[0];
                if (!file) return alert("Please select a file.");

                uploadBtn.disabled = true;
                status.innerText = "Requesting Auth... ðŸ”‘";

                fetch(CLOUDFLARE_AUTH_ENDPOINT)
                    .then(response => {
                        if (!response.ok) throw new Error("Auth Server Error");
                        return response.json();
                    })
                    .then(authData => {
                        status.innerText = "Beaming up... ðŸ›¸ (Don't close window)";
                        
                        imagekit.upload({
                            file: file,
                            fileName: file.name,
                            tags: ["meetup2026"],
                            token: authData.token,
                            signature: authData.signature,
                            expire: authData.expire
                        }, function(err, result) {
                            if (err) {
                                console.error("SDK Error:", err);
                                status.innerText = "Upload failed: " + (err.message || "Unknown error");
                            } else {
                                status.innerText = "Touchdown! Success.";
                                addPhotoToGrid(result.url, file.type.includes('video'));
                            }
                            uploadBtn.disabled = false;
                        });
                    })
                    .catch(err => {
                        console.error("Auth Fail:", err);
                        status.innerText = "Auth failed. Is your Worker running?";
                        uploadBtn.disabled = false;
                    });
            });

            // Run initial load
            loadGallery();
        });
    </script>
</body>
</html>

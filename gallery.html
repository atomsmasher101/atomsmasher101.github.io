<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama Memories - Wilmington 2026</title>
    <style>
        /* --- Styles: Minimalist Vaporwave --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial Black', sans-serif;
            background: #000;
            color: #fff;
            padding-top: 100px;
        }
        nav {
            position: fixed; top: 0; width: 100%;
            background: rgba(0, 0, 0, 0.9);
            padding: 1rem; z-index: 1000;
            border-bottom: 2px solid #ff00ff;
            text-align: center;
        }
        nav a { color: #00ffff; text-decoration: none; margin: 0 15px; font-weight: 900; text-transform: uppercase; }
        
        .upload-card {
            max-width: 500px; margin: 0 auto 3rem auto; padding: 2rem;
            border: 2px solid #ff00ff; border-radius: 15px; text-align: center;
            background: #111;
        }
        .upload-btn {
            padding: 12px 24px; background: #00ffff; color: #000;
            border: none; border-radius: 25px; font-weight: 900;
            cursor: pointer; margin-top: 15px;
        }
        .upload-btn:disabled { background: #333; color: #666; }

        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto;
        }
        .gallery-item { height: 300px; border-radius: 10px; overflow: hidden; background: #222; border: 1px solid #333; }
        .gallery-item img, .gallery-item video { width: 100%; height: 100%; object-fit: cover; }
        .status-msg { margin-top: 10px; color: #ffff00; font-size: 0.9rem; }
    </style>
</head>
<body>

    <nav>
        <a href="index.html">Home</a>
        <a href="gallery.html">Gallery</a>
    </nav>

    <section class="upload-card">
        <h2 style="color:#ff00ff; margin-bottom:15px;">UPLOAD MEDIA</h2>
        <input type="file" id="file-selector" accept="image/*,video/*">
        <br>
        <button id="upload-btn" class="upload-btn">BEAM UP ðŸ›¸</button>
        <div id="upload-status" class="status-msg">Select a file to begin.</div>
    </section>

    <div class="gallery-grid" id="gallery-grid"></div>

    <script src="https://cdn.jsdelivr.net/npm/imagekit-javascript@1.5.9/dist/imagekit.min.js"></script>
    
    <script>
        // --- SETTINGS ---
        const IK_PUBLIC_KEY = "public_1ErPhSlplr1rBPQCe5DZtkYi+CY=";
        const IK_URL_ENDPOINT = "https://ik.imagekit.io/atomsmasher101/";
        const CLOUDFLARE_AUTH_ENDPOINT = "https://nc2026photoupload.littleredatom.workers.dev/";
        const RESTRICTED_API_KEY = "private_/k8K1Gh7XeNUfj7kL0X0qgo7lCg=";

        // 1. Initialize
        const imagekit = new ImageKit({
            publicKey: IK_PUBLIC_KEY,
            urlEndpoint: IK_URL_ENDPOINT
        });

        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-selector');
        const status = document.getElementById('upload-status');
        const grid = document.getElementById('gallery-grid');

        // 2. Load Existing Gallery
        async function loadGallery() {
            const b64Key = btoa(RESTRICTED_API_KEY + ":");
            try {
                const response = await fetch("https://api.imagekit.io/v1/files?tags=meetup2026", {
                    headers: { 'Authorization': `Basic ${b64Key}` }
                });
                const files = await response.json();
                grid.innerHTML = '';
                files.forEach(file => {
                    const isVid = file.fileType === 'non-image' && file.mime.includes('video');
                    addPhotoToGrid(file.url, isVid);
                });
            } catch (err) {
                console.error("Gallery Load Fail:", err);
            }
        }

        function addPhotoToGrid(url, isVideo = false) {
            const div = document.createElement('div');
            div.className = 'gallery-item';
            const thumbUrl = isVideo ? url : `${url}?tr=w-600`;
            div.innerHTML = isVideo ? `<video src="${url}" controls></video>` : `<img src="${thumbUrl}" loading="lazy">`;
            grid.prepend(div);
        }

        // 3. The Stabilized Upload Logic
        uploadBtn.addEventListener('click', function() {
            const file = fileInput.files[0];
            if (!file) return alert("Please select a file.");

            uploadBtn.disabled = true;
            status.innerText = "Requesting Auth... ðŸ”‘";

            // Step 1: Get signature from Cloudflare
            fetch(CLOUDFLARE_AUTH_ENDPOINT)
                .then(response => response.json())
                .then(authData => {
                    status.innerText = "Uploading... (This may take a moment) ðŸ›¸";
                    
                    // Step 2: Use SDK to upload
                    imagekit.upload({
                        file: file,
                        fileName: file.name,
                        tags: ["meetup2026"],
                        token: authData.token,
                        signature: authData.signature,
                        expire: authData.expire
                        // Note: XHR progress block removed to prevent e.open error
                    }, function(err, result) {
                        if (err) {
                            console.error("SDK Error:", err);
                            status.innerText = "Error: " + (err.message || "Upload failed");
                        } else {
                            status.innerText = "Success! Media added.";
                            addPhotoToGrid(result.url, file.type.includes('video'));
                        }
                        uploadBtn.disabled = false;
                    });
                })
                .catch(err => {
                    console.error("Auth Fail:", err);
                    status.innerText = "Auth failed. Check Worker.";
                    uploadBtn.disabled = false;
                });
        });

        window.addEventListener('DOMContentLoaded', loadGallery);
    </script>
</body>
</html>

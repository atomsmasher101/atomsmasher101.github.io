<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama Memories - Wilmington 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial Black', sans-serif;
            background: #000;
            color: #fff;
            padding-top: 100px;
            overflow-x: hidden;
        }
        nav {
            position: fixed; top: 0; width: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem; z-index: 1000;
            border-bottom: 2px solid #ff00ff;
        }
        nav ul { list-style: none; display: flex; justify-content: center; gap: 2rem; }
        nav a { color: #00ffff; text-decoration: none; font-weight: 900; text-transform: uppercase; font-size: 0.9rem; }
        
        .upload-card {
            max-width: 600px; margin: 0 auto 4rem auto; padding: 2.5rem;
            border: 3px solid #ff00ff; border-radius: 25px; text-align: center;
            background: rgba(255, 0, 255, 0.05); box-shadow: 0 0 20px rgba(255, 0, 255, 0.2);
        }
        .progress-container {
            width: 100%; height: 12px; background: #111; border-radius: 10px;
            margin: 20px 0; overflow: hidden; display: none; border: 1px solid #333;
        }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ff00ff, #00ffff); transition: width 0.2s ease; }
        
        .upload-btn {
            padding: 1rem 2rem; background: linear-gradient(135deg, #00ffff, #ffff00);
            color: #000; border: none; border-radius: 50px; font-weight: 900;
            cursor: pointer; text-transform: uppercase;
        }
        .upload-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .gallery-container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .gallery-item { height: 350px; border-radius: 20px; overflow: hidden; border: 2px solid #333; transition: 0.3s; background: #111; }
        .gallery-item img, .gallery-item video { width: 100%; height: 100%; object-fit: cover; }
        .status-msg { margin-top: 1rem; color: #00ffff; font-family: 'Arial', sans-serif; }
    </style>
</head>
<body>

    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="gallery.html" style="color:#ffff00;">Gallery</a></li>
        </ul>
    </nav>

    <header style="text-align: center; margin-bottom: 2rem;">
        <h1 style="font-size: clamp(2rem, 5vw, 3rem); color: #ff00ff; text-transform: uppercase;">Llama Memories</h1>
    </header>

    <section class="upload-card">
        <h2>Submit Media</h2>
        <input type="file" id="file-selector" accept="image/*,video/*">
        <div class="progress-container" id="progress-container"><div id="progress-bar"></div></div>
        <button id="upload-btn" class="upload-btn">Beam it up! ðŸ›¸</button>
        <div id="upload-status" class="status-msg">Ready for liftoff.</div>
    </section>

    <section class="gallery-container">
        <div class="gallery-grid" id="gallery-grid"></div>
    </section>

    <script src="https://unpkg.com/imagekit-javascript/dist/imagekit.min.js"></script>
    <script>
        // --- SETTINGS ---
        const IK_PUBLIC_KEY = "public_1ErPhSlplr1rBPQCe5DZtkYi+CY=";
        const IK_URL_ENDPOINT = "https://ik.imagekit.io/atomsmasher101/";
        const CLOUDFLARE_AUTH_ENDPOINT = "https://nc2026photoupload.littleredatom.workers.dev/";
        const RESTRICTED_API_KEY = "private_/k8K1Gh7XeNUfj7kL0X0qgo7lCg=";

        const imagekit = new ImageKit({
            publicKey: IK_PUBLIC_KEY,
            urlEndpoint: IK_URL_ENDPOINT
        });

        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-selector');
        const status = document.getElementById('upload-status');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const grid = document.getElementById('gallery-grid');

        // 1. Load Gallery
        async function loadGallery() {
            const b64Key = btoa(RESTRICTED_API_KEY + ":");
            try {
                const response = await fetch("https://api.imagekit.io/v1/files?tags=meetup2026", {
                    headers: { 'Authorization': `Basic ${b64Key}` }
                });
                const files = await response.json();
                grid.innerHTML = '';
                files.forEach(file => {
                    const isVid = file.fileType === 'non-image' && file.mime.includes('video');
                    addPhotoToGrid(file.url, isVid);
                });
            } catch (err) {
                console.error("Gallery Load Fail:", err);
            }
        }

        function addPhotoToGrid(url, isVideo = false) {
            const div = document.createElement('div');
            div.className = 'gallery-item';
            const thumbUrl = isVideo ? url : `${url}?tr=w-600`;
            div.innerHTML = isVideo ? `<video src="${url}" controls></video>` : `<img src="${thumbUrl}" loading="lazy">`;
            grid.prepend(div);
        }

        // 2. The Final Upload Logic
        uploadBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) return alert("Please select a file.");

            uploadBtn.disabled = true;
            status.innerText = "Requesting Auth... ðŸ”‘";

            try {
                // Fetch the signature manually to bypass SDK quirks
                const authResponse = await fetch(CLOUDFLARE_AUTH_ENDPOINT);
                if (!authResponse.ok) throw new Error("Worker Auth Failed");
                const authData = await authResponse.json();

                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                status.innerText = "Uploading to ImageKit... ðŸ›¸";

                imagekit.upload({
                file: file,
                fileName: file.name,
                tags: ["meetup2026"],
                token: authData.token,
                signature: authData.signature,
                expire: authData.expire,
                // Fix: Using a standard function instead of arrow function for xhr
                xhr: function() {
                    var xhr = new XMLHttpRequest();
                    xhr.upload.addEventListener("progress", function(evt) {
                        if (evt.lengthComputable) {
                            var p = (evt.loaded / evt.total) * 100;
                            progressBar.style.width = p + '%';
                            status.innerText = `Lifting off: ${Math.round(p)}%`;
                        }
                    });
                    return xhr;
                }
            }, function(err, result) {
                if (err) {
                    console.error("IK Error:", err);
                    status.innerText = "Error: " + (err.message || "Upload Failed");
                } else {
                    status.innerText = "Touchdown! Success.";
                    addPhotoToGrid(result.url, file.type.includes('video'));
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        status.innerText = "Ready for another?";
                    }, 3000);
                }
                uploadBtn.disabled = false;
            });

            } catch (err) {
                console.error("Full Flow Error:", err);
                status.innerText = "Worker Error. Check Logs.";
                uploadBtn.disabled = false;
            }
        });

        window.addEventListener('DOMContentLoaded', loadGallery);
    </script>
</body>
</html>
